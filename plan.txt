1. Executive Summary & GoalsBuild a local-first EPUB reader for Desktop (Windows/macOS/Linux) and Mobile (Android).Source of Truth: Google Drive (Files + hidden sync.json).Primary Key: Google Drive fileId.Sync Logic: "Last-Write-Wins" using Unix timestamps for EPUB-CFI locations.Performance: Local storage for reading; cloud only for initial download and background syncing.2. Information Architecture & RoutesBoth apps share a common UI structure (Next.js App Router):/ (Library): The "Home" view. Displays a grid of book covers.States: Cloud-only (cloud icon), Downloaded (no icon), Sync-Pending (dirty icon)./reader/[fileId]: The main reading interface using epub.js.Features: Table of Contents, Search, Settings (Font, Theme)./settings: Account info (Google profile), toggle for "Sync only on Wi-Fi," Clear Cache./auth: Handling the Google OAuth callback and token refresh.3. Core Data Model (The "Sync Contract")A. Local DB (IndexedDB via Dexie.js)TypeScriptinterface LocalBook {
  fileId: string;       // GDrive ID
  title: string;
  author: string;
  coverBlob: Blob;      // Cached locally
  localPath: string;    // Path on device (different for Electron/Capacitor)
  lastCfi: string;      // Latest reading position
  timestamp: number;    // Unix time of last update
  isDirty: boolean;     // Needs push to cloud?
  downloadStatus: 'pending' | 'downloading' | 'ready';
}
B. Cloud Sync File (appDataFolder/sync.json)JSON{
  "last_device": "Desktop-Alpha",
  "books": {
    "FILE_ID_1": { "cfi": "epubcfi(...)", "ts": 1706452800000 },
    "FILE_ID_2": { "cfi": "epubcfi(...)", "ts": 1706452800050 }
  }
}
4. Platform Boundary Logic (The Adapters)To make one codebase work on two systems, the agent must implement these interfaces:Featureapps/desktop (Electron)apps/mobile (Capacitor)File Storagefs-extra + app.getPath('userData')@capacitor/filesystem (Data Dir)Google Authgoogle-auth-library (Loopback)@capacitor-community/google-signinConnectivityNode net or navigator.onLine@capacitor/networkWindow Stateelectron-window-stateNative Fullscreen mode5. Sequence of Implementation (Milestones)Milestone 1: Authentication & DiscoverySetup Google Cloud Project with three client IDs (Web, Android, iOS).Implement GoogleDriveService to list all .epub files in the user's Drive.Verify the app can access the hidden appDataFolder.Milestone 2: File LifecycleImplement the "Download & Cache" logic.Electron: Stream download to the local user directory.Capacitor: Use native fetch to save to the app's persistent storage.Milestone 3: The Reader & Sync LoopIntegrate epub.js into a shared React component.Trigger: On page change, update the local DB.Trigger: On app close/background, fire SyncEngine.push().Resolution: If cloud timestamp is higher than local, show a "Pick up where you left off?" toast.Milestone 4: Polishing & Edge CasesImplement "Conflict Mode": If two devices update at the same time, the most recent timestamp wins.Handle "Token Expired" events: Automatically refresh Google tokens without interrupting the user.6. Critical Implementation Details for the AgentShared UI Component Library: All UI components (buttons, modals, book cards) must live in packages/ui using Tailwind.Stateless Components: The Reader should be "dumb"â€”it takes a local file path and a CFI and returns a new CFI when pages turn.The "Dirty" Flag: Any change made while offline must be marked isDirty: true in Dexie. The SyncEngine must retry these whenever a network connection is detected.Static Export: Ensure next.config.js uses output: 'export' so both Electron and Capacitor can load the app via file://.






ðŸ“– Project: "Lumina Reader" Master Plan
1. Project Overview
A local-first EPUB reader for Windows/macOS/Linux (Electron) and Android (Capacitor).

Source of Truth: Google Drive (Files + hidden sync.json).

Database: IndexedDB (Local cache) with a "Last-Write-Wins" sync strategy.

UI Framework: Next.js (Static Export) + Tailwind CSS + Lucide Icons.

2. Google Cloud Setup (Critical)
The agent must configure the following in the Google Cloud Console:

API Enabled: Google Drive API v3.

OAuth Scopes:

https://www.googleapis.com/auth/drive.appdata (For the hidden sync.json).

https://www.googleapis.com/auth/drive.readonly (To list and download EPUB files).

Client IDs:

Web Client ID: Used as the base for all platforms.

Android Client ID: Requires the package name and SHA-1 certificate fingerprint.

iOS Client ID: (Optional, if added later) Requires Bundle ID.

3. Monorepo Architecture
Use pnpm workspaces for logic sharing.

Plaintext
/lumina-reader
â”œâ”€â”€ packages/
â”‚   â”œâ”€â”€ core/               # Shared logic: GDrive API, Sync Engine, Dexie DB
â”‚   â”‚   â”œâ”€â”€ src/api/        # drive-client.ts, sync-service.ts
â”‚   â”‚   â””â”€â”€ src/db/         # schema.ts (Dexie)
â”‚   â””â”€â”€ ui/                 # Shared React Components (Reader.tsx, BookCard.tsx)
â”œâ”€â”€ apps/
â”‚   â”œâ”€â”€ desktop/            # Electron + Next.js
â”‚   â”‚   â””â”€â”€ src/main.ts     # Main process (handles local fs & auth loopback)
â”‚   â””â”€â”€ mobile/             # Capacitor + Next.js
â”‚       â””â”€â”€ capacitor.config.ts
4. Data & Sync Logic
Local Database (Dexie.js / IndexedDB)
TypeScript
interface BookStore {
  fileId: string;       // GDrive ID (Primary Key)
  title: string;
  author: string;
  localPath: string;    // Path on local device
  lastCfi: string;      // Reading position (epubcfi)
  ts: number;           // Unix timestamp of last local update
  isDirty: boolean;     // True if needs upload to cloud
}
Sync Strategy (The "Handshake")
When a book is opened:

Check sync.json in GDrive appDataFolder.

If cloud_ts > local_ts: Update local position.

On page turn: Update local DB immediately.

On app close: Push local "dirty" states to sync.json and mark isDirty: false.

5. Implementation Roadmap
Phase 1: Authentication Shell
Desktop: Implement an Electron loopback server (usually on port 4200) to receive the OAuth2 callback.

Mobile: Use @capacitor-community/google-signin to handle the native Android account picker.

Phase 2: File Management
Create a GDriveService to list .epub files.

Implement a "Local Library" service:

Electron: Uses node:fs to save books in userData/library.

Capacitor: Uses @capacitor/filesystem to save in Directory.Data.

Phase 3: The Reader Component
Wrap epub.js in a React component.

Add a onLocationChange listener that triggers the SyncService.

Ensure the component supports "Offline Mode"â€”if the file is downloaded, it should load from the local path, not the network.

6. Crucial Agent Constraints
Next.js Export: Must use output: 'export' and trailingSlash: true. No Server Actions or SSR.

Protocol Handling: The Desktop app should register a custom protocol (e.g., lumina://) to handle deep links.

Large Files: EPUBs can be 100MB+. Do not load them into memory all at once; use Blob URLs.

